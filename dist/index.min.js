!function(){var l;function i(e,r){var t,n={}.hasOwnProperty;for(t in r)n.call(r,t)&&(e[t]=r[t]);return e}(l=function(e){return null==e&&(e={}),this.inited=!1,this._init=[],this.worker=null,this.queue={main:null,list:[]},this.evtHandler={},this.workerUrl=e.worker||"/assets/lib/@plotdb/ffmpeg/main/worker.js",this.canvas=document.createElement("canvas"),this}).args={mp4:["-framerate","<fps>","-i","%05d.png","-c:v","libx264","-r","<fps>","-preset","<preset>","-crf","<crf>","-pix_fmt","yuv420p","-b:v","0","out.mp4"],webm:["-framerate","<fps>","-i","%05d.png","-c:v","libvpx","-r","<fps>","-preset","<preset>","-crf","<crf>","-auto-alt-ref","0","-b:v","0","out.webm"],webp:["-framerate","<fps>","-i","%05d.png","-c:v","libwebp","-r","<fps>","-loop","<loopValue>","-quality","<quality>","-compression_level","4","out.webp"],gif:["-framerate","<fps>","-i","%05d.png","-c:v","gif","-r","<fps>","-loop","<loopValue>","-vf","split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse","out.gif"]},l.prototype=i(Object.create(Object.prototype),{on:function(e,t){var n=this;return(Array.isArray(e)?e:[e]).map(function(e){var r;return((r=n.evtHandler)[e]||(r[e]=[])).push(t)})},fire:function(e){for(var r,t,n,i,s=[],o=[],u=1,a=arguments.length;u<a;++u)o.push(arguments[u]);for(r=o,u=0,n=(t=this.evtHandler[e]||[]).length;u<n;++u)i=t[u],s.push(i.apply(this,r));return s},init:function(){var i=this;return new Promise(function(n,e){return i.inited?n():(i.worker&&i._init.push({res:n,rej:e}),i.worker=new Worker(i.workerUrl),i.worker.onmessage=function(e){var r,t=e.data;switch(t.type){case"ready":return i.inited=!0,n(),i._init.splice(0).map(function(e){return e.res()});case"stderr":if(console.log(t.data),(r=/frame=\s*(\d+)/.exec(t.data||""))&&i._progress)return i._progress(+r[1]);break;case"done":if(i.queue.main)return i.queue.main.res(t.data),i.queue.main=null,(r=i.queue.list.splice(0,1)[0])?r.res():void 0}})})},cancel:function(){var e;this.queue.main&&(this.queue.main.rej(((e=new Error).name="lderror",e.id=999,e.msg="canceled",e)),this.queue.main=null,this.worker.terminate(),this.worker=null,this.inited=!1,e=this.queue.list.splice(0,1)[0])&&e.res()},_convert:function(t){var n=this;return(this.queue.main?new Promise(function(e,r){return n.queue.list.push({res:e,rej:r})}):Promise.resolve()).then(function(){return new Promise(function(e,r){return n.queue.main={res:e,rej:r},n.init().then(function(){return n.worker.postMessage(i({type:"run"},t))})})})},convert:function(e){var t=this,r=e.files,n=e.format,i=e.progress,s=e.fps,e=e.repeatCount,o=[r||[],n||"webm",this.canvas],u=o[2],a="gif"===(n=o[1])?null!=e&&e?1===e?-1:e-1:0:null==e?0:e,e=(r=o[0]).map(function(t){var e;return"string"==typeof t&&((e=new Image).src=t,t=e),t instanceof Image?(t.complete?Promise.resolve():new Promise(function(e,r){return t.onload=function(){return e()}})).then(function(){var e=t.width,r=t.height;return u.width=e,u.height=r,u.getContext("2d").drawImage(t,0,0,e,r),new Promise(function(t,e){return u.toBlob(function(e){var r=new FileReader;return r.onload=function(){return t(new Uint8Array(r.result))},r.readAsArrayBuffer(e)},"image/png")})}):t instanceof ArrayBuffer?Promise.resolve(new Uint8Array(t)):Promise.resolve(t)});return Promise.all(e).then(function(r){var e;return r=r.map(function(e,r){return{name:(""+r).padStart(5,"0")+".png",data:e}}),e={arguments:[].concat(l.args[n]).map(function(e){return"<loopValue>"===e?a+"":"<preset>"===e?"ultrafast":"<fps>"===e?s+"":"<quality>"===e?"80":"<crf>"===e?"18":e}),MEMFS:r,TOTAL_MEMORY:4294967296},i&&(t._progress=function(e){return i((e||0)/r.length)},t._progress(0)),t._convert(e)}).then(function(e){return i&&(this._progress=null,i(1)),new Blob([e.MEMFS[0].data],{type:"webp"===n?"image/webp":"video/"+n})})}}),"undefined"!=typeof module&&null!==module?module.exports=l:"undefined"!=typeof window&&null!==window&&(window.ffmpeg=l)}.call(this);

(function(){function e(e,r){var n={}.hasOwnProperty;for(var t in r)n.call(r,t)&&(e[t]=r[t]);return e}var r;(r=function(e){return null==e&&(e={}),this.inited=!1,this._init=[],this.worker=null,this.queue={main:null,list:[]},this.evtHandler={},this.workerUrl=e.worker||"/assets/lib/@plotdb/ffmpeg/main/worker.js",this.canvas=document.createElement("canvas"),this}).args={mp4:["-i","%05d.png","-c:v","libx264","-pix_fmt","yuv420p","out.mp4"],webm:["-i","%05d.png","-auto-alt-ref","0","-c:v","libvpx","-b:v","2M","-crf","-1","out.webm"],webp:["-i","%05d.png","-vcodec","libwebp_anim","-lossless","1","-loop","0","out.webp"]},r.prototype=e(Object.create(Object.prototype),{on:function(e,r){var n=this;return(Array.isArray(e)?e:[e]).map(function(e){var t;return((t=n.evtHandler)[e]||(t[e]=[])).push(r)})},fire:function(e){var r,n,t,i,o,u,s,a=[];for(n=[],t=1,i=arguments.length;t<i;++t)n.push(arguments[t]);for(r=n,t=0,u=(o=this.evtHandler[e]||[]).length;t<u;++t)s=o[t],a.push(s.apply(this,r));return a},init:function(){var e=this;return new Promise(function(r,n){return e.inited?r():(e.worker&&e._init.push({res:r,rej:n}),e.worker=new Worker(e.workerUrl),e.worker.onmessage=function(n){var t,i;switch((t=n.data).type){case"ready":return e.inited=!0,r(),e._init.splice(0).map(function(e){return e.res()});case"stderr":if(console.log(t.data),!(i=/frame=\s*(\d+)/.exec(t.data||"")))return;if(e._progress)return e._progress(+i[1]);break;case"done":if(!e.queue.main)return;if(e.queue.main.res(t.data),e.queue.main=null,!(i=e.queue.list.splice(0,1)[0]))return;return i.res()}})})},_convert:function(r){var n=this;return(this.queue.main?new Promise(function(e,r){return n.queue.list.push({res:e,rej:r})}):Promise.resolve()).then(function(){return new Promise(function(t,i){return n.queue.main={res:t,rej:i},n.worker.postMessage(e({type:"run"},r))})})},convert:function(e){var n,t,i,o,u,s,a=this;return n=e.files,t=e.format,i=e.progress,o=[n||[],t||"webm",this.canvas],n=o[0],t=o[1],u=o[2],s=n.map(function(e){var r;return"string"==typeof e&&((r=new Image).src=e,e=r),e instanceof Image?(e.complete?Promise.resolve():new Promise(function(r,n){return e.onload=function(){return r()}})).then(function(){var r,n;return r=e.width,n=e.height,u.width=r,u.height=n,u.getContext("2d").drawImage(e,0,0,r,n),new Promise(function(e,r){return u.toBlob(function(r){var n;return n=new FileReader,n.onload=function(){return e(new Uint8Array(n.result))},n.readAsArrayBuffer(r)},"image/png")})}):e instanceof ArrayBuffer?Promise.resolve(new Uint8Array(e)):Promise.resolve(e)}),Promise.all(s).then(function(e){var n;return e=e.map(function(e,r){return{name:(""+r).padStart(5,"0")+".png",data:e}}),n={arguments:r.args[t],MEMFS:e,TOTAL_MEMORY:4294967296},i&&(a._progress=function(r){return i((r||0)/e.length)},a._progress(0)),a._convert(n)}).then(function(e){return i&&(this._progress=null,i(1)),new Blob([e.MEMFS[0].data],{type:"webp"===t?"image/webp":"video/"+t})})}}),"undefined"!=typeof module&&null!==module?module.exports=r:"undefined"!=typeof window&&null!==window&&(window.ffmpeg=r)}).call(this);

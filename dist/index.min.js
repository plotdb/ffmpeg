!function(){var u;function i(e,r){var n,t={}.hasOwnProperty;for(n in r)t.call(r,n)&&(e[n]=r[n]);return e}(u=function(e){return null==e&&(e={}),this.inited=!1,this._init=[],this.worker=null,this.queue={main:null,list:[]},this.evtHandler={},this.workerUrl=e.worker||"/assets/lib/@plotdb/ffmpeg/main/worker.js",this.canvas=document.createElement("canvas"),this}).args={mp4:["-i","%05d.png","-c:v","libx264","-pix_fmt","yuv420p","out.mp4"],webm:["-i","%05d.png","-auto-alt-ref","0","-c:v","libvpx","-b:v","2M","-crf","-1","out.webm"],webp:["-i","%05d.png","-vcodec","libwebp_anim","-lossless","1","-loop","0","out.webp"]},u.prototype=i(Object.create(Object.prototype),{on:function(e,n){var t=this;return(Array.isArray(e)?e:[e]).map(function(e){var r;return((r=t.evtHandler)[e]||(r[e]=[])).push(n)})},fire:function(e){for(var r,n,t,i,o=[],u=[],s=1,a=arguments.length;s<a;++s)u.push(arguments[s]);for(r=u,s=0,t=(n=this.evtHandler[e]||[]).length;s<t;++s)i=n[s],o.push(i.apply(this,r));return o},init:function(){var i=this;return new Promise(function(t,e){return i.inited?t():(i.worker&&i._init.push({res:t,rej:e}),i.worker=new Worker(i.workerUrl),i.worker.onmessage=function(e){var r,n=e.data;switch(n.type){case"ready":return i.inited=!0,t(),i._init.splice(0).map(function(e){return e.res()});case"stderr":if(console.log(n.data),!(r=/frame=\s*(\d+)/.exec(n.data||"")))return;if(i._progress)return i._progress(+r[1]);break;case"done":return i.queue.main?(i.queue.main.res(n.data),i.queue.main=null,(r=i.queue.list.splice(0,1)[0])?r.res():void 0):void 0}})})},_convert:function(n){var t=this;return(this.queue.main?new Promise(function(e,r){return t.queue.list.push({res:e,rej:r})}):Promise.resolve()).then(function(){return new Promise(function(e,r){return t.queue.main={res:e,rej:r},t.worker.postMessage(i({type:"run"},n))})})},convert:function(e){var t,n=this,r=e.files,i=e.format,o=e.progress,e=[r||[],i||"webm",this.canvas];return i=e[1],t=e[2],r=(r=e[0]).map(function(n){var e;return"string"==typeof n&&((e=new Image).src=n,n=e),n instanceof Image?(n.complete?Promise.resolve():new Promise(function(e,r){return n.onload=function(){return e()}})).then(function(){var e=n.width,r=n.height;return t.width=e,t.height=r,t.getContext("2d").drawImage(n,0,0,e,r),new Promise(function(n,e){return t.toBlob(function(e){var r=new FileReader;return r.onload=function(){return n(new Uint8Array(r.result))},r.readAsArrayBuffer(e)},"image/png")})}):n instanceof ArrayBuffer?Promise.resolve(new Uint8Array(n)):Promise.resolve(n)}),Promise.all(r).then(function(r){var e;return r=r.map(function(e,r){return{name:(""+r).padStart(5,"0")+".png",data:e}}),e={arguments:u.args[i],MEMFS:r,TOTAL_MEMORY:4294967296},o&&(n._progress=function(e){return o((e||0)/r.length)},n._progress(0)),n._convert(e)}).then(function(e){return o&&(this._progress=null,o(1)),new Blob([e.MEMFS[0].data],{type:"webp"===i?"image/webp":"video/"+i})})}}),"undefined"!=typeof module&&null!==module?module.exports=u:"undefined"!=typeof window&&null!==window&&(window.ffmpeg=u)}.call(this);

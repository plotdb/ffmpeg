!function(){var l;function i(e,r){var n,t={}.hasOwnProperty;for(n in r)t.call(r,n)&&(e[n]=r[n]);return e}(l=function(e){return null==e&&(e={}),this.inited=!1,this._init=[],this.worker=null,this.queue={main:null,list:[]},this.evtHandler={},this.workerUrl=e.worker||"/assets/lib/@plotdb/ffmpeg/main/worker.js",this.canvas=document.createElement("canvas"),this}).args={mp4:["-i","%05d.png","-preset","ultrafast","-c:v","libx264","-pix_fmt","yuv420p","out.mp4"],webm:["-i","%05d.png","-preset","ultrafast","-auto-alt-ref","0","-c:v","libvpx","-b:v","2M","-crf","-1","out.webm"],webp:["-i","%05d.png","-vcodec","libwebp","-lossless","1","-loop","<loopValue>","out.webp"],gif:["-i","%05d.png","-ss","30","-t","3","-vf","fps=10,scale=320:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse","-loop","<loopValue>","out.gif"]},l.prototype=i(Object.create(Object.prototype),{on:function(e,n){var t=this;return(Array.isArray(e)?e:[e]).map(function(e){var r;return((r=t.evtHandler)[e]||(r[e]=[])).push(n)})},fire:function(e){for(var r,n,t,i,o=[],s=[],u=1,a=arguments.length;u<a;++u)s.push(arguments[u]);for(r=s,u=0,t=(n=this.evtHandler[e]||[]).length;u<t;++u)i=n[u],o.push(i.apply(this,r));return o},init:function(){var i=this;return new Promise(function(t,e){return i.inited?t():(i.worker&&i._init.push({res:t,rej:e}),i.worker=new Worker(i.workerUrl),i.worker.onmessage=function(e){var r,n=e.data;switch(n.type){case"ready":return i.inited=!0,t(),i._init.splice(0).map(function(e){return e.res()});case"stderr":if(console.log(n.data),(r=/frame=\s*(\d+)/.exec(n.data||""))&&i._progress)return i._progress(+r[1]);break;case"done":if(i.queue.main)return i.queue.main.res(n.data),i.queue.main=null,(r=i.queue.list.splice(0,1)[0])?r.res():void 0}})})},cancel:function(){var e;this.queue.main&&(this.queue.main.rej(((e=new Error).name="lderror",e.id=999,e.msg="canceled",e)),this.queue.main=null,this.worker.terminate(),this.worker=null,this.inited=!1,e=this.queue.list.splice(0,1)[0])&&e.res()},_convert:function(n){var t=this;return(this.queue.main?new Promise(function(e,r){return t.queue.list.push({res:e,rej:r})}):Promise.resolve()).then(function(){return new Promise(function(e,r){return t.queue.main={res:e,rej:r},t.init().then(function(){return t.worker.postMessage(i({type:"run"},n))})})})},convert:function(e){var n=this,r=e.files,t=e.format,i=e.progress,o=e.fps,e=e.repeatCount,s=[r||[],t||"webm",this.canvas],u=s[2],a="gif"===(t=s[1])?null!=e&&e?1===e?-1:e-1:0:null==e?0:e,e=(r=s[0]).map(function(n){var e;return"string"==typeof n&&((e=new Image).src=n,n=e),n instanceof Image?(n.complete?Promise.resolve():new Promise(function(e,r){return n.onload=function(){return e()}})).then(function(){var e=n.width,r=n.height;return u.width=e,u.height=r,u.getContext("2d").drawImage(n,0,0,e,r),new Promise(function(n,e){return u.toBlob(function(e){var r=new FileReader;return r.onload=function(){return n(new Uint8Array(r.result))},r.readAsArrayBuffer(e)},"image/png")})}):n instanceof ArrayBuffer?Promise.resolve(new Uint8Array(n)):Promise.resolve(n)});return Promise.all(e).then(function(r){var e;return r=r.map(function(e,r){return{name:(""+r).padStart(5,"0")+".png",data:e}}),(e=(e=[].concat(l.args[t])).map(function(e){return"<loopValue>"!==e?e:a+""})).splice(0,0,"-r",(o||30)+""),e={arguments:e,MEMFS:r,TOTAL_MEMORY:4294967296},i&&(n._progress=function(e){return i((e||0)/r.length)},n._progress(0)),n._convert(e)}).then(function(e){return i&&(this._progress=null,i(1)),new Blob([e.MEMFS[0].data],{type:"webp"===t?"image/webp":"video/"+t})})}}),"undefined"!=typeof module&&null!==module?module.exports=l:"undefined"!=typeof window&&null!==window&&(window.ffmpeg=l)}.call(this);
